/**********************************************************************
 *  Project       Harman Car Multimedia System
 *  (c) copyright 2013
 *  Company       Harman/Becker Automotive Systems GmbH
 *                All rights reserved
 **********************************************************************/

/*
 * Generated by DSI Generator version 2.0
 * Date: 6.5.2013
 */


struct _DMMTunerAnnouncementProxy ;
#define TDSIClient struct _DMMTunerAnnouncementProxy

/*
 * Remove the const from the attributes for this module.
 */
#define DSICONST


#include "DMMTunerAnnouncementProxy.h"

static const char* SERVER_NAME = "DMMTunerAnnouncement" ;
static const int SERVER_MAJOR_VERSION = 1 ;
static const int SERVER_MINOR_VERSION = 2 ;


static void DMMTunerAnnouncementReadErrorEnumerator( DMMTunerAnnouncementProxy* proxy, DSIStream* stream )
{
   (void)proxy;
}


static void ProcessResponse( DMMTunerAnnouncementProxy* proxy, DSIStream* stream, const EventInfo* event )
{
   if( event->responseType == RESULT_INVALID )
   {
      DMMTunerAnnouncementReadErrorEnumerator( proxy, stream );

      if( proxy->fnResponseInvalid )
      {
         proxy->fnResponseInvalid( proxy, (DMMTunerAnnouncement_UpdateIdEnum)event->requestID );
      }
   }
   else if( event->responseType == RESULT_REQUEST_ERROR
           || event->responseType == RESULT_REQUEST_BUSY
           || event->responseType == RESULT_NOP )   // FIXME remove when MoCCA is fixed
   {
      DMMTunerAnnouncementReadErrorEnumerator( proxy, stream );

      switch( event->requestID )
      {
      case DMMTunerAnnouncement_UPD_ID_requestSetFilter:
         if( proxy->fnRequestSetFilterFailed )
         {
            proxy->fnRequestSetFilterFailed( proxy, (DSIResultType)event->responseType );
         }
         break;

      case DMMTunerAnnouncement_UPD_ID_requestAbort:
         if( proxy->fnRequestAbortFailed )
         {
            proxy->fnRequestAbortFailed( proxy, (DSIResultType)event->responseType );
         }
         break;

      case DMMTunerAnnouncement_UPD_ID_requestStartTune:
         if( proxy->fnRequestStartTuneFailed )
         {
            proxy->fnRequestStartTuneFailed( proxy, (DSIResultType)event->responseType );
         }
         break;

      case DMMTunerAnnouncement_UPD_ID_requestUnblockStation:
         if( proxy->fnRequestUnblockStationFailed )
         {
            proxy->fnRequestUnblockStationFailed( proxy, (DSIResultType)event->responseType );
         }
         break;

      case DMMTunerAnnouncement_UPD_ID_requestSetFilters:
         if( proxy->fnRequestSetFiltersFailed )
         {
            proxy->fnRequestSetFiltersFailed( proxy, (DSIResultType)event->responseType );
         }
         break;

      default:
         assert( 0 );
         break;
      }
   }
   else
   {
      int bSendEvent = 0 ;
      switch( event->requestID )
      {
      case DMMTunerAnnouncement_UPD_ID_filters:
         {
            // Free previous allocated data
            DMMTunerAnnouncement_Filters_Free( &proxy->filters );

            // set attribute state
            DSI_SETSTATE( proxy->filters, event->responseType == RESULT_DATA_OK ? DATA_OK : DATA_INVALID );

            // read the attribute data
            if( event->responseType == RESULT_DATA_OK )
            {
               DSIReadDMMTunerAnnouncement_Filters( stream, &proxy->filters ) ;
            }
            bSendEvent = 1 ;
         }
         break;

      case DMMTunerAnnouncement_UPD_ID_announcements:
         {
            // Free previous allocated data
            DMMTunerAnnouncement_Announcements_Free( &proxy->announcements );

            // set attribute state
            DSI_SETSTATE( proxy->announcements, event->responseType == RESULT_DATA_OK ? DATA_OK : DATA_INVALID );

            // read the attribute data
            if( event->responseType == RESULT_DATA_OK )
            {
               DSIReadDMMTunerAnnouncement_Announcements( stream, &proxy->announcements ) ;
            }
            bSendEvent = 1 ;
         }
         break;

      case DMMTunerAnnouncement_UPD_ID_currentStation:
         {
            // Free previous allocated data
            DMMTunerAnnouncement_Station_Free( &proxy->currentStation );

            // set attribute state
            DSI_SETSTATE( proxy->currentStation, event->responseType == RESULT_DATA_OK ? DATA_OK : DATA_INVALID );

            // read the attribute data
            if( event->responseType == RESULT_DATA_OK )
            {
               DSIReadDMMTunerAnnouncement_Station( stream, &proxy->currentStation ) ;
            }
            bSendEvent = 1 ;
         }
         break;

      case DMMTunerAnnouncement_UPD_ID_tunerState:
         {
            // Free previous allocated data
            DMMTunerAnnouncement_TunerState_Free( &proxy->tunerState );

            // set attribute state
            DSI_SETSTATE( proxy->tunerState, event->responseType == RESULT_DATA_OK ? DATA_OK : DATA_INVALID );

            // read the attribute data
            if( event->responseType == RESULT_DATA_OK )
            {
               DSIReadDMMTunerAnnouncement_TunerState( stream, &proxy->tunerState ) ;
            }
            bSendEvent = 1 ;
         }
         break;

      case DMMTunerAnnouncement_UPD_ID_responseSetFilter:
         {
            unsigned int handle = 0 ;
            DMMTunerTypes_Feedback feedback = 0 ;
            DSIRead32( stream, &handle ) ;
            DSIRead32( stream, &feedback ) ;
            if( proxy->fnResponseSetFilter )
            {
               proxy->fnResponseSetFilter( proxy, handle, feedback );
            }
         }
         break;

      case DMMTunerAnnouncement_UPD_ID_responseAbort:
         {
            unsigned int handle = 0 ;
            DMMTunerTypes_Feedback feedback = 0 ;
            DSIRead32( stream, &handle ) ;
            DSIRead32( stream, &feedback ) ;
            if( proxy->fnResponseAbort )
            {
               proxy->fnResponseAbort( proxy, handle, feedback );
            }
         }
         break;

      case DMMTunerAnnouncement_UPD_ID_responseStartTune:
         {
            unsigned int handle = 0 ;
            DMMTunerTypes_Feedback feedback = 0 ;
            DSIRead32( stream, &handle ) ;
            DSIRead32( stream, &feedback ) ;
            if( proxy->fnResponseStartTune )
            {
               proxy->fnResponseStartTune( proxy, handle, feedback );
            }
         }
         break;

      case DMMTunerAnnouncement_UPD_ID_informationCurrentAnnouncement:
         {
            DMMTunerAnnouncement_Announcement announcement ;
            memset( &announcement, 0, sizeof(announcement) )  ;
            DSIReadDMMTunerAnnouncement_Announcement( stream, &announcement ) ;
            if( proxy->fnInformationCurrentAnnouncement )
            {
               proxy->fnInformationCurrentAnnouncement( proxy,  &announcement );
            }
            DMMTunerAnnouncement_Announcement_Free( &announcement );
         }
         break;

      case DMMTunerAnnouncement_UPD_ID_responseSetFilters:
         {
            unsigned int handle = 0 ;
            DMMTunerTypes_Feedbacks feedbacks = 0 ;
            DSIRead32( stream, &handle ) ;
            DSIReadDMMTunerTypes_Feedbacks( stream, &feedbacks ) ;
            if( proxy->fnResponseSetFilters )
            {
               proxy->fnResponseSetFilters( proxy, handle, feedbacks );
            }
            if( proxy->fnResponseSetFiltersEx )
            {
               proxy->fnResponseSetFiltersEx( proxy, handle, DSIVectorData( feedbacks ), DSIVectorSize( feedbacks ) );
            }
            DMMTunerTypes_Feedbacks_Free( &feedbacks );
         }
         break;

      default:
         assert( 0 ); // unknown update id
         break;
      }

      if( bSendEvent && proxy->fnProcessUpdateEvent )
      {
         // notify the user about the update
         proxy->fnProcessUpdateEvent( proxy, (DMMTunerAnnouncement_UpdateIdEnum)event->requestID );
      }
   }
}

int DMMTunerAnnouncement_RequestSetFilter( DMMTunerAnnouncementProxy* proxy, const DMMTunerAnnouncement_Filter* filter,  unsigned int handle )
{
   int seqNr = DSICreateId();
   DSIStream stream ;
   DSIOpen( &stream );
   DSIWriteDMMTunerAnnouncement_Filter( &stream, filter ) ;
   DSIWrite32( &stream, &handle ) ;
   DSIClientSendRequest( proxy, DMMTunerAnnouncement_UPD_ID_requestSetFilter, seqNr, &stream );
   DSIClose( &stream );
   return seqNr ;
}



int DMMTunerAnnouncement_RequestAbort( DMMTunerAnnouncementProxy* proxy, const DMMTunerAnnouncement_StationSelector* source,  DMMTunerAnnouncement_AnnouncementType type,  unsigned int handle )
{
   int seqNr = DSICreateId();
   DSIStream stream ;
   DSIOpen( &stream );
   DSIWriteDMMTunerAnnouncement_StationSelector( &stream, source ) ;
   DSIWrite32( &stream, &type ) ;
   DSIWrite32( &stream, &handle ) ;
   DSIClientSendRequest( proxy, DMMTunerAnnouncement_UPD_ID_requestAbort, seqNr, &stream );
   DSIClose( &stream );
   return seqNr ;
}



int DMMTunerAnnouncement_RequestStartTune( DMMTunerAnnouncementProxy* proxy, const DMMTunerAnnouncement_StationSelector* station,  DSIBool blockStation,  unsigned int handle )
{
   int seqNr = DSICreateId();
   DSIStream stream ;
   DSIOpen( &stream );
   DSIWriteDMMTunerAnnouncement_StationSelector( &stream, station ) ;
   DSIWriteBool( &stream, &blockStation ) ;
   DSIWrite32( &stream, &handle ) ;
   DSIClientSendRequest( proxy, DMMTunerAnnouncement_UPD_ID_requestStartTune, seqNr, &stream );
   DSIClose( &stream );
   return seqNr ;
}



int DMMTunerAnnouncement_RequestUnblockStation( DMMTunerAnnouncementProxy* proxy )
{
   int seqNr = DSICreateId();
   DSIStream stream ;
   DSIOpen( &stream );
   DSIClientSendRequest( proxy, DMMTunerAnnouncement_UPD_ID_requestUnblockStation, seqNr, &stream );
   DSIClose( &stream );
   return seqNr ;
}



int DMMTunerAnnouncement_RequestSetFilters( DMMTunerAnnouncementProxy* proxy, const DMMTunerAnnouncement_Filters filters,  unsigned int handle )
{
   int seqNr = DSICreateId();
   DSIStream stream ;
   DSIOpen( &stream );
   DSIWriteDMMTunerAnnouncement_Filters( &stream, &filters ) ;
   DSIWrite32( &stream, &handle ) ;
   DSIClientSendRequest( proxy, DMMTunerAnnouncement_UPD_ID_requestSetFilters, seqNr, &stream );
   DSIClose( &stream );
   return seqNr ;
}

int DMMTunerAnnouncement_RequestSetFiltersEx( DMMTunerAnnouncementProxy* proxy, const DMMTunerAnnouncement_Filter* filters, int filtersSize,  unsigned int handle )
{
   int seqNr = DSICreateId();
   DSIStream stream ;
   DSIOpen( &stream );
   DSIWrite32( &stream, &filtersSize );
   if( 0 != filtersSize )
   {
      int idx=0;
      while( idx < filtersSize )
      {
         DSIWriteDMMTunerAnnouncement_Filter( &stream, &filters[idx] ) ;
         idx++;
      }
   }
   DSIWrite32( &stream, &handle ) ;
   DSIClientSendRequest( proxy, DMMTunerAnnouncement_UPD_ID_requestSetFilters, seqNr, &stream );
   DSIClose( &stream );
   return seqNr ;
}





/*******************************************************************************************/

static void ComponentConnected( DMMTunerAnnouncementProxy* proxy )
{
   if( proxy->fnComponentConnected )
   {
      proxy->fnComponentConnected( proxy );
   }
}

static void ComponentDisconnected( DMMTunerAnnouncementProxy* proxy )
{
   if( proxy->fnComponentDisconnected )
   {
      proxy->fnComponentDisconnected( proxy );
   }
}

static void ProcessInternalEvent( DMMTunerAnnouncementProxy* proxy, int code, void* data )
{
   if( proxy->fnProcessInternalEvent )
   {
      proxy->fnProcessInternalEvent( proxy, code, data );
   }
}

static void Cleanup( DMMTunerAnnouncementProxy* proxy )
{
   if( proxy->fnCleanup )
   {
      proxy->fnCleanup( proxy );
   }
}

/*** notifications *************************************************************************/

void DMMTunerAnnouncementProxy_SetNotification( DMMTunerAnnouncementProxy* proxy, DMMTunerAnnouncement_UpdateIdEnum updateId )
{
   DSIClientSetNotification( proxy, (int)updateId );
}


void DMMTunerAnnouncementProxy_ClearNotification( DMMTunerAnnouncementProxy* proxy, DMMTunerAnnouncement_UpdateIdEnum updateId )
{
   DSIClientClearNotification( proxy, (int)updateId );
}


void DMMTunerAnnouncementProxy_ClearAllNotifications( DMMTunerAnnouncementProxy* proxy )
{
   DSIClientClearAllNotifications( proxy );
}

/*** (de)initialization ********************************************************************/

int DMMTunerAnnouncementProxy_Init( DMMTunerAnnouncementProxy* proxy, const char* rolename )
{
   DSIInit();
   memset( proxy, 0, sizeof(*proxy) );
   DSIClientInit( proxy, SERVER_NAME, rolename, SERVER_MAJOR_VERSION, SERVER_MINOR_VERSION );
   proxy->client.fnComponentConnected = ComponentConnected ;
   proxy->client.fnComponentDisconnected = ComponentDisconnected ;
   proxy->client.fnProcessResponse = ProcessResponse ;
   proxy->client.fnProcessInternalEvent = ProcessInternalEvent ;
   proxy->client.fnCleanup = Cleanup ;
   return 0 ;
}

void DMMTunerAnnouncementProxy_Free( DMMTunerAnnouncementProxy* proxy  )
{
   DMMTunerAnnouncement_Filters_Free( &proxy->filters );
   DMMTunerAnnouncement_Announcements_Free( &proxy->announcements );
   DMMTunerAnnouncement_Station_Free( &proxy->currentStation );
   DMMTunerAnnouncement_TunerState_Free( &proxy->tunerState );
   DSIClientFree( proxy );
   memset( proxy, 0, sizeof(*proxy) );
}

int DMMTunerAnnouncementProxy_Start( DMMTunerAnnouncementProxy* proxy, const char* rolename )
{
   // do not call the _Init function here since the proxy will be NULL'ed which makes problems with
   // the CPP implementation callbacks already registered...

   DSIInit();
   DSIClientInit( proxy, SERVER_NAME, rolename, SERVER_MAJOR_VERSION, SERVER_MINOR_VERSION );
   proxy->client.fnComponentConnected = ComponentConnected ;
   proxy->client.fnComponentDisconnected = ComponentDisconnected ;
   proxy->client.fnProcessResponse = ProcessResponse ;
   proxy->client.fnProcessInternalEvent = ProcessInternalEvent ;
   proxy->client.fnCleanup = Cleanup ;
   return DSIClientRun( proxy );
}

int DMMTunerAnnouncementProxy_Stop( DMMTunerAnnouncementProxy* proxy, int exitcode )
{
   return DSIClientStop( proxy, exitcode );
}

int DMMTunerAnnouncementProxy_PostInternalEvent( DMMTunerAnnouncementProxy* proxy, int code, void* data )
{
   return DSIPostInternalEvent( proxy->client.Channel.Master, proxy->client.Id, 0, code, data );
}

int DMMTunerAnnouncementProxy_SendInternalEvent( DMMTunerAnnouncementProxy* proxy, int code, void* data )
{
   return DSISendInternalEvent( proxy->client.Channel.Master, proxy->client.Id, 0, code, data );
}


